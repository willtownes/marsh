---
title: "Salamander Analysis- Stan Results"
author: "Will Townes"
date: "5/23/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(rstan)
library(cowplot)
load("data/bl_stanfit.rda") #blfit, bl
load("data/po_stanfit.rda") #pofit, po
dat<-read.csv("data/merged_data.csv")

#check for stan errors
if(blfit@mode != 0) stop("bl_stanfit did not converge, try again!")
if(pofit@mode != 0) stop("po_stanfit did not converge, try again!")
```

## Negative Binomial Model

### Posterior Mean of Temperature Functions

Big levels location

```{r}
tof<-10 #temperature offset (Celsius)
bl_mn<-summary(blfit,pars=c("a","b","c","d"),probs=NULL)$summary[,"mean"]
bl_bl<-function(t){
  res<-bl_mn["c[1]"]+(t-tof)*bl_mn["b[1]"]+(t-tof)^2*bl_mn["a[1]"]
  exp(res)
}
bl_rb<-function(t){
  res<-bl_mn["c[2]"]+(t-tof)*bl_mn["b[2]"]+(t-tof)^2*bl_mn["a[2]"]
  exp(res)
}
bl_col<-c(blnh="#009E73",rbnh="#D55E00")
bl_plt<-ggplot(subset(dat,site=="BL"),aes(x=temp,colour=saltype))+ylab("count of adult salamanders")+scale_color_manual(values=bl_col)+xlim(c(0,25))+geom_point(aes(y=salcount))+stat_function(fun=bl_rb,colour=bl_col["rbnh"])+stat_function(fun=bl_bl,colour=bl_col["blnh"])
show(bl_plt)
show(bl_plt+coord_trans(y="log1p"))
```

peaks of otter location

```{r}
po_mn<-summary(pofit,pars=c("a","b","c","d"),probs=NULL)$summary[,"mean"]
po_po<-function(t){
  res<-po_mn["c[1]"]+(t-tof)*po_mn["b[1]"]+(t-tof)^2*po_mn["a[1]"]
  exp(res)
}
po_rb<-function(t){
  res<-po_mn["c[2]"]+(t-tof)*po_mn["b[2]"]+(t-tof)^2*po_mn["a[2]"]
  exp(res)
}
po_col<-c(ponh="#0072B2",rbnh="#D55E00")
po_plt<-ggplot(subset(dat,site=="PO"),aes(x=temp,colour=saltype))+ylab("count of adult salamanders")+scale_color_manual(values=po_col)+xlim(c(0,25))+geom_point(aes(y=salcount))+stat_function(fun=po_rb,colour=po_col["rbnh"])+stat_function(fun=po_po,colour=po_col["ponh"])
show(po_plt)
show(po_plt+coord_trans(y="log1p"))
```

Combining the two locations into a single plot

```{r}
plot_grid(bl_plt+coord_trans(y="log1p"),po_plt+coord_trans(y="log1p"),nrow=2)
```

### Alternative Parameterization

Dr. Marsh's model is `SALCOUNT (neg.bin) ~ SPECIES + temp + temp^2 + SPECIES*temp + SPECIES*temp^2 +soilMS + (~1|date)`. Consider the quadratic function on the log scale, with $\mu$ the mean abundance and $x$ representing temperature:

$$\log\mu = ax^2+bx+c$$

There are three parameters, $a,b,c$. Using some algebra, we can re-parameterize this relationship as

$$\log\mu = -s\left(\frac{x-q}{w/2}\right)^2+s$$

The parameters $q,r,s$ are more interpretable: $q=-b/(2a)$ is the temperature at which abundance reaches its peak. The maximum abundance is given by $e^s$ where $s=c-b^2/(4a)$ and the range of temperatures where log-abundance is expected to be more than zero has width $w=\sqrt{b^2-4ac}/|a|$. Based on this transformation, we can compare the abundance curves for different species by looking at contrasts in these parameters. For example, we can ask

* Do the two species reach maximum abundance at different temperatures? (comparing $q$)
* Does one species have a wider temperature range? (comparing $w$)
* Is one species more abundant than the other (comparing $s$)

To improve numerical stability while working with the quadratic temperature terms, we would prefer to work with the offset temperature $x-k$ where $k$ is some baseline temperature. Based on the above plots, we could set $k=10$ (ie temperature relative to 10 degrees celsius). Then the temperature at which abundance reaches its peak changes to $q+k$ instead of $q$. The other two parameters retain the same interpretation when calculated on the offset scale.

In a previous step, we already transformed temperature by subtracting it from the offset of 10 degrees Celsius for both the BL and PO datasets. We also transformed soil moisture by subtracting off the median at each site. So, if we set soil moisture to zero it is the same as interpreting the parameters at the median level for each site.

```{r}
transform_temp_pars<-function(a,b,c){
  #a,b,c are vectors
  #each element represents a sample from posterior distribution
  #quadratic model a*x^2+b*x+c
  #x represents temperature (from the data)
  #returns data frame with transformed parameters
  q<- -b/(2*a)
  w<- sqrt(b^2 - 4*a*c)/abs(a)
  s<- c - b^2/(4*a)
  data.frame(q=q, s=s, w=w)
}

transform_all_pars<-function(stfit,species=c("en","rb")){
  #stfit a stan fit object (produced by 02_stan_fit.R)
  #returns a data frame with all parameters of interest:
  #rows are samples from posterior distribution
  #species 1 is endemic, species 2 is red-backed
  #extract sample draws for fixed effects
  species<-match.arg(species)
  i<-if(species=="en") 1 else 2
  parnames<-paste0(c("a","b","c"),"[",i,"]")
  res<-as.data.frame(stfit,pars=parnames)
  colnames(res)<-c("a","b","c")
  res$q<- with(res, -b/(2*a))
  res$w<- with(res, sqrt(b^2 - 4*a*c)/abs(a))
  res$s<- with(res, c - b^2/(4*a))
  res
}
bl_res<-list(en=transform_all_pars(blfit,"en"),rb=transform_all_pars(blfit,"rb"))
#some NaN values usually show up for the "w" (width) transformed parameters
#number of NaN values, should be small
with(bl_res,table(is.nan(en$w)))
with(bl_res,table(is.nan(rb$w)))
```

Compare peak abundance temperatures for red-backed versus big levels endemic at the Big Levels site. We find that the 95% credible interval for the difference between their peak abundance temperatures covers zero. Hence, there does not appear to be evidence that these two species have different temperature preferences.
```{r}
#distribution of (q_r-q_e) difference between peak abundance temps
with(bl_res,quantile(rb$q - en$q,c(.025,.975)))
```

Does one species have a wider range than the other? Again there does not appear to be a difference.
```{r}
with(bl_res,quantile(rb$w - en$w,c(.025,.975),na.rm=TRUE))
```

Same comparisons at the peaks of otter site
```{r}
po_res<-list(en=transform_all_pars(pofit,"en"),rb=transform_all_pars(pofit,"rb"))
#some NaN values usually show up for the "w" (width) transformed parameters
#number of NaN values, should be small
with(po_res,table(is.nan(en$w)))
with(po_res,table(is.nan(rb$w)))
```

Do the peaks of otter (endemics) have a higher or lower temperature at which they reach peak abundance? The difference does not appear to be significant.
```{r}
#distribution of (q_r-q_e) difference between peak abundance temps
with(po_res,quantile(rb$q - en$q,c(.025,.975)))
```

Does one species have a wider range than the other? Again there does not appear to be a difference.
```{r}
with(po_res,quantile(rb$w - en$w,c(.025,.975),na.rm=TRUE))
```

old code, keeping for reference

```{r, eval=FALSE}
other_saltype_name<-pn[3]
#saltype_other<-as.data.frame(with(res,transform_temp_pars(

#res<-cbind(res,

res<-summary(stfit)$summary[,c("mean","2.5%","97.5%")]
beta<-as.data.frame(res[startsWith(rownames(res),"beta"),])
beta$signif<-beta[,"2.5%"]*beta[,"97.5%"]>0 #CI spans zero?
rownames(beta)<-colnames(stdat$X)
#beta is matrix with rows=parameters and cols=mean and conf. interval.
sigma<-res["sigma",]
rand_ints<-res[startsWith(rownames(res),"rand_ints"),]
hist(exp(rand_ints[,"mean"])) #visualize random intercept distribution
phi<-res[startsWith(rownames(res),"phi"),]
#visualize the implied curves
temp_curve<-function(x,species=c("blnh","ponh","rbnh"),temp_offset=10,logscale=TRUE){
  #prediction for log-mean function
  species<-match.arg(species)
  xt<-x-temp_offset
  b<-beta[,"mean"]
  names(b)<-rownames(beta)
  lmu<-b["(Intercept)"]+b["soilWC"]*wc_median+b["temp"]*xt+b["temp2"]*xt^2
  #if(species=="rbnh"){
  #  lmu<-lmu+b["saltyperbnh"]+b["saltyperbnh:temp"]*xt+b["saltyperbnh:temp2"]*xt^2
  #}
  if(species=="blnh"){
    lmu<-lmu+b["saltypeblnh"]+b["saltypeblnh:temp"]*xt+b["saltypeblnh:temp2"]*xt^2
  }
  if(!logscale) return(exp(lmu))
  lmu
}

ggplot(dat[dat$site=="BL",],aes(x=temp,y=salcount,colour=saltype))+geom_point() + stat_function(fun=function(x){temp_curve(x,"blnh",logscale=FALSE)},colour="black") + stat_function(fun=function(x){temp_curve(x,"rbnh",logscale=FALSE)},colour="black")+xlab("temperature(C)")+ylab("salamander abundance (count)")

knitr::kable(beta)
knitr::kable(phi)
```

As shown above, the negative binomial model suggests there is a small but significant difference in the temperature profiles for the red backed and peaks of otter salamanders. In particular, the peaks of otter salamanders seem to prefer slightly higher temperatures than the red backs.

TODO- include the reparameterized (easier to interpret) version in the Stan program and make boxplots showing distributions of the contrasts.
