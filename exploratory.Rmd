---
title: "Exploring Salamander Data"
author: "Will Townes"
date: "October 11, 2016"
output: pdf_document
---

```{r setup}
#knitr::opts_chunk$set(echo = TRUE)
library(modules)
import_package("ggplot2",attach=TRUE)
reshape2<-import_package("reshape2")
#save_plots<-TRUE
#ggs<-function(x,plt_path="results/plots"){if(save_plots) ggsave(file.path(plt_path,x))}
library(rstan)
rstan_options(auto_write=TRUE)
options(mc.cores=max(parallel::detectCores()-1,1))
```

## Scientific Question

Which species of salamander is more tolerant of warm temperatures? The redbacked salamander is the low elevation common species, while the big levels (or peaks of otter) species is rare and endemic to higher elevations.

Response variables

* ponh- peaks of otter no hatchling counts
* rbnh- red backed no hatchling counts

Covariates

* Date- each row in original data is a single date. No duplicates.
* plot- binary hi/lo (elevation)
* soilWC- soil moisture. Has missing values
* temp- temperature. Expect maximum activity at intermediate temperature ranges

Dr. Marsh tried negative binomial regression, including date as random intercept.

## Exploratory Data Analysis

```{r}
#read in data and convert to ggplot friendly format
d<-read.csv("data/PORBsummary.csv")
d$poscaled<-d$pototal<-d$rbtotal<-d$rbscaled<-d$temp2<-NULL
d2<-reshape2$melt(d,c("Date","plot","soilWC","temp"),c("ponh","rbnh"),"saltype",value.name="salcount")
d2$lsalcount<-log2(.5+d2$salcount)
d$po_frac<-with(d,ponh/(ponh+rbnh)) #fraction of peaks of otter salamanders
```

looking for patterns

```{r}
#plt_path<-"results/plots/exploratory"
ggplot(d2)+geom_boxplot(aes(plot,salcount,fill=saltype))+ggtitle("Red Backed dominant at both elevations?")
```

Red backed salamanders (RB) are more abundant at both high and elevation plots compared to the endemic peaks of otter salamanders (PO). Notably the distributions do not differ much between the two elevation plots.

```{r}
ggplot(d,aes(x=temp,y=ponh+rbnh))+geom_point()+geom_smooth()+ggtitle("total salcount vs temperature")
ggplot(d2,aes(x=temp,y=salcount,colour=saltype))+geom_point()+geom_smooth()+ggtitle("salcount by species versus temperature")
#log scale same plot
ggplot(d2,aes(x=temp,y=log2(.5+salcount),colour=saltype))+geom_point()+geom_smooth()+ggtitle("log-abundance by species versus temperature")
```

We see the maximum overall abundance seems to occur at approximately 13C. The maximum for RB is closer to 12.5C and the maximum for PO is closer to 13.5C. On the log scale, there appears to be a quadratic relationship.

What happens if we use *fraction* of peaks of otter salamanders instead of counts?

```{r}
#any pattern using proportion instead of count?
ggplot(d,aes(x=temp,y=po_frac))+geom_point()+geom_smooth()
```

The PO salamanders are most abundant relative to RB at a temperature of about 16C. This is much higher than the peak of absolute abundance.

```{r}
#soil moisture
ggplot(d2,aes(x=soilWC,y=salcount,colour=saltype))+geom_point()+geom_smooth()
ggplot(d2,aes(x=soilWC,y=log2(.5+salcount),colour=saltype))+geom_point()+geom_smooth()
```

On the log scale, abundance tends to increase linearly with soil moisture content.

## Negative Binomial Model

Dr. Marsh's model is `SALCOUNT (neg.bin) ~ SPECIES + temp + temp^2 + SPECIES*temp + SPECIES*temp^2 +soilMS + (~1|date)`. Consider the quadratic function on the log scale, with $\mu$ the mean abundance and $x$ representing temperature:

$$\log\mu = ax^2+bx+c$$

There are three parameters, $a,b,c$. Using some algebra, we can re-parameterize this relationship as

$$\log\mu = -s\left(\frac{x-q}{w}\right)^2+s$$

The parameters $q,r,s$ are more interpretable: $q=-b/(2a)$ is the temperature at which abundance reaches its peak. The maximum abundance is given by $e^s$ where $s=c-b^2/(4a)$ and the range of temperatures where abundance is expected to be more than one has width $2r$ where $r=\sqrt{b^2-4ac}/(2|a|)$. Based on this transformation, we can compare the abundance curves for different species by looking at contrasts in these parameters. For example, we can ask

* Do the two species reach maximum abundance at different temperatures? (comparing $q$)
* Does one species have a wider temperature range? (comparing $r$)
* Is one species more abundant than the other (comparing $s$)

To improve numerical stability while working with the quadratic temperature terms, we would prefer to work with the offset temperature $x-k$ where $k$ is some baseline temperature. Based on the above plots, we could set $k=10$ (ie temperature relative to 10 degrees celsius). Then the temperature at which abundance reaches its peak changes to $q+k$ instead of $q$. The other two parameters retain the same interpretation when calculated on the offset scale.

We now organize the data such that it can be passed to Stan for modeling. Note that we use the negative binomial likelihood with a separate dispersion parameter for the two salamander species.

```{r}
temp_offset<-10
#package data into list
d3<-d2[complete.cases(d2),]
d3$temp<-d3$temp-temp_offset
d3$temp2<-d3$temp^2
dat<-list(id=as.integer(d3$Date)) #cluster id
dat$K<-max(dat$id) #number of clusters
dat$X<-model.matrix(~soilWC+saltype*(temp+temp2),d3) #fixed covariates
dat$N<-nrow(dat$X); dat$D<-ncol(dat$X) #dimensionality
dat$y<-d3$salcount #outcomes (counts)
dat$phi_group<-as.integer(d3$saltype)
```
```{r}
#compile Stan model
nb_quadratic<-stan_model(file="stan_models/nb_quadratic.stan")
```
```{r}
#run model
system.time(stfit<-sampling(nb_quadratic,data=dat))
```
```{r}
res<-summary(stfit)$summary[,c("mean","2.5%","97.5%")]
beta<-as.data.frame(res[startsWith(rownames(res),"beta"),])
beta$signif<-beta[,"2.5%"]*beta[,"97.5%"]>0 #CI spans zero?
rownames(beta)<-colnames(X)
knitr::kable(beta)
#beta is matrix with rows=parameters and cols=mean and conf. interval.
sigma<-res["sigma",]
rand_ints<-res[startsWith(rownames(res),"rand_ints"),]
hist(exp(rand_ints[,"mean"])) #visualize random intercept distribution
phi<-res[startsWith(rownames(res),"phi"),]
#visualize the implied curves
temp_curve<-function(x,species=c("ponh","rbnh"),temp_offset=10,logscale=TRUE){
  #prediction for log-mean function
  species<-match.arg(species)
  xt<-x-temp_offset
  b<-beta[,"mean"]
  names(b)<-rownames(beta)
  lmu<-b["(Intercept)"]+b["soilWC"]*median(d3$soilWC)+b["temp"]*xt+b["temp2"]*xt^2
  if(species=="rbnh"){
    lmu<-lmu+b["saltyperbnh"]+b["saltyperbnh:temp"]*xt+b["saltyperbnh:temp2"]*xt^2
  }
  if(!logscale) return(exp(lmu))
  lmu
}

ggplot(d3,aes(x=temp+temp_offset,y=salcount,colour=saltype))+geom_point() + stat_function(fun=function(x){temp_curve(x,"ponh",logscale=FALSE)},colour="black") + stat_function(fun=function(x){temp_curve(x,"rbnh",logscale=FALSE)},colour="black")

knitr::kable(phi)
```

